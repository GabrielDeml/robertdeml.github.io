<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Static Map</title>
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    .section {
      width: 100%;
      height: 100vh;
      overflow: auto;
    }

    .image-container {
      max-width: 100%;
      max-height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .image-container img {
      max-width: 100%;
      height: auto;
    }

    .marker {
      position: absolute;
      width: 10px;
      height: 10px;
      background-color: red;
      border-radius: 50%;
      transform: translate(-50%, -50%);
    }

    .current-position-marker {
      position: absolute;
      width: 10px;
      height: 10px;
      background-color: lime;
      border-radius: 50%;
      transform: translate(-50%, -50%);
    }

    .point-data {
      position: absolute;
      top: 0px;
      left: 0px;
      color: white;
    }
  </style>
</head>

<body>
  <div class="section" id="section">
    <div class="image-container" id="image-container">
      <img src="your-image.JPG" alt="Your Image" id="image" />
    </div>
  </div>
  <div class="point-data">
    <div>Pt1: <span id="ref1">ref1</span></div>
    <div>Pt2: <span id="ref2">ref2</span></div>
    <div>Pt2: <span id="ref3"></span></div>
    <div>Pos: <span id="current-position">ref3</span></div>
  </div>

  <script>

    let gpsToMapRotation;
    let gpsToMapScale;
    let gpsLatitude;
    let gpsLongitude;
    let mapX;
    let mapY;
    let currentPositionInterval;

    // delta = 0.0026551, 0.00016
    // rotation = -1.648076382, 
    // scale = 62046.306
    // const a = {
    //   dataset: {
    //     latitude: .9299554,
    //     longitude: .4967629,
    //     x: 100,
    //     y: 100,
    //   }
    // };
    // const b = {
    //   dataset: {
    //     latitude: .9326105,
    //     longitude: .49692,
    //     x: 200,
    //     y: 100,
    //   }
    // };
    function measure(lat1, lon1, lat2, lon2) {  // generally used geo measurement function
      var R = 6378.137; // Radius of earth in KM
      var dLat = lat2 * Math.PI / 180 - lat1 * Math.PI / 180;
      var dLon = lon2 * Math.PI / 180 - lon1 * Math.PI / 180;
      var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      var d = R * c;
      return d * 1000; // meters
    }

    const saveTransformations = (a, b) => {
      const gpsAngle = Math.atan2(b.dataset.latitude - a.dataset.latitude, b.dataset.longitude - a.dataset.longitude);
      const mapAngle = Math.atan2(b.dataset.y - a.dataset.y, b.dataset.x - a.dataset.x);
      gpsToMapRotation = mapAngle - gpsAngle;

      const gpsDistance = Math.sqrt(Math.pow(b.dataset.latitude - a.dataset.latitude, 2) + Math.pow(b.dataset.longitude - a.dataset.longitude, 2));
      const mapDistance = Math.sqrt(Math.pow(b.dataset.y - a.dataset.y, 2) + Math.pow(b.dataset.x - a.dataset.x, 2));
      gpsToMapScale = mapDistance / gpsDistance;

      const gpsDistanceMeters = measure(b.dataset.latitude, b.dataset.longitude, a.dataset.latitude, a.dataset.longitude);

      if (!isFinite(gpsToMapScale)) {
        gpsToMapScale = 1;
      }

      gpsLatitude = a.dataset.latitude;
      gpsLongitude = a.dataset.longitude;
      mapX = a.dataset.x;
      mapY = a.dataset.y;

      document.querySelector('#ref1').innerHTML = `gps:${a.dataset.longitude}, ${a.dataset.latitude}<br>acc: ${a.dataset.accuracy} <br>map: ${a.dataset.x},${a.dataset.y}`;
      document.querySelector('#ref2').innerHTML = `gps:${b.dataset.longitude}, ${b.dataset.latitude}<br>acc: ${b.dataset.accuracy} <br>map: ${b.dataset.x},${b.dataset.y}`;
      document.querySelector('#ref3').innerHTML = `gpsDist:${gpsDistance}<br>gpsDist2: ${gpsDistanceMeters}<br>mappDist: ${mapDistance} <br>scale: ${gpsToMapScale}`;
    };

    const plotCurrentPosition = () => {
      const locationSuccess = (position) => {
        // Create a marker element
        let marker = document.querySelector(".current-position-marker");
        if (!marker) {
          marker = document.createElement("div");
        }
        marker.className = "current-position-marker";

        const latitude = position.coords.latitude;
        const longitude = position.coords.longitude;
        console.log("position: ", latitude, longitude);
        marker.dataset.latitude = latitude;
        marker.dataset.longitude = longitude;

        // Set the marker's position based on rotation and scale
        const translateX = longitude - gpsLongitude;
        const translateY = latitude - gpsLatitude;
        const rotateX = translateX * Math.cos(gpsToMapRotation);
        const rotateY = translateY * Math.sin(gpsToMapRotation);
        const scaleX = rotateX * gpsToMapScale;
        const scaleY = rotateY * gpsToMapScale;

        const x = scaleX + mapX;
        const y = scaleY + mapY;
        marker.style.left = x + "px";
        marker.style.top = y + "px";
        marker.dataset.x = x;
        marker.dataset.y = y;

        document.querySelector('#current-position').innerHTML = `${longitude}, ${latitude}, ${x}, ${y}`;

        // Append the marker to the container
        imageContainer.appendChild(marker);
      }

      const locationError = () => {
        console.log('error getting location.');
      }

      if (!navigator.geolocation) {
        console.log("Geolocation is not supported by your browser");
      } else {
        console.log("Locatingâ€¦");
        navigator.geolocation.getCurrentPosition(locationSuccess, locationError);
      }
    }

    let markerId = 0;
    const markers = [];

    // Get the image element and container
    const section = document.getElementById("section");
    const image = document.getElementById("image");
    const imageContainer = document.getElementById("image-container");

    const removeAllBut1Marker = () => {
      if (imageContainer.querySelectorAll('.marker').length > 1) {
        imageContainer.querySelectorAll('.marker')[0].remove();
      }
    };

    const appendNewPoint = (event) => {
      // Create a marker element
      const marker = document.createElement("div");
      marker.className = "marker";

      // Set the marker's position based on click coordinates
      const mouseX = event.clientX + section.scrollLeft;
      const mouseY = event.clientY + section.scrollTop;
      marker.style.left = mouseX + "px";
      marker.style.top = mouseY + "px";
      marker.dataset.x = mouseX;
      marker.dataset.y = mouseY;
      markerId++;
      marker.id = `marker_${markerId}`;

      // Append the marker to the container
      imageContainer.appendChild(marker);
      return marker.id;
    };

    // Add a click event listener to the image
    image.addEventListener("click", function (event) {
      /**
       * Click -> 
       *          Whlie there is more than 1 point
       *            Remove the first point
       *          Append a new point
       *          if there are 2 points
       *            Calculate translation constants
       *            Start Interval if not started
      */
      removeAllBut1Marker();

      const markerId = appendNewPoint(event);

      const locationSuccess = (markerId) => (position) => {
        const latitude = position.coords.latitude;
        const longitude = position.coords.longitude;
        const accuracy = position.coords.accuracy;

        const marker = imageContainer.querySelector(`#${markerId}`);
        if (!marker) return;
        marker.dataset.latitude = latitude;
        marker.dataset.longitude = longitude;
        marker.dataset.accuracy = accuracy;

        if (imageContainer.querySelectorAll(".marker").length === 2) {
          const a = imageContainer.querySelectorAll('.marker')[0];
          const b = imageContainer.querySelectorAll('.marker')[1];

          saveTransformations(a, b);
          if (currentPositionInterval == null) {
            currentPositionInterval = setInterval(plotCurrentPosition, 5 * 1000);
          }
        }
      }
      const locationError = () => {
        console.log('error getting location.');
      }

      if (!navigator.geolocation) {
        console.log("Geolocation is not supported by your browser");
      } else {
        navigator.geolocation.getCurrentPosition(locationSuccess(markerId), locationError);
      }
    });
  </script>
</body>

</html>