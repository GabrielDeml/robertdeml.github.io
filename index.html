<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Static Map</title>
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    .section {
      width: 100%;
      height: 100vh;
      overflow: auto;
    }

    .image-container {
      max-width: 100%;
      max-height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .image-container img {
      max-width: 100%;
      height: auto;
    }

    .marker {
      position: absolute;
      width: 10px;
      height: 10px;
      background-color: red;
      border-radius: 50%;
      transform: translate(-50%, -50%);
    }

    .current-position-marker {
      position: absolute;
      width: 10px;
      height: 10px;
      background-color: lime;
      border-radius: 50%;
      transform: translate(-50%, -50%);
    }

    .point-data {
      position: absolute;
      top: 0px;
      left: 0px;
      color: white;
    }
  </style>
</head>

<body>
  <div class="section" id="section">
    <div class="image-container" id="image-container">
      <img src="your-image.JPG" alt="Your Image" id="image" />
    </div>
  </div>
  <div class="point-data">
    <div>Pt1: <span id="ref1">ref1</span></div>
    <div>Pt2: <span id="ref2">ref2</span></div>
    <div>Pos: <span id="current-position">ref3</span></div>
  </div>

  <script>
    let gpsToMapRotation;
    let gpsToMapScale;
    let gpsLatitude;
    let gpsLongitude;
    let mapX;
    let mapY;

    // delta = 0.0026551, 0.00016
    // rotation = -1.648076382, 
    // scale = 62046.306
    const saveTransformations = (a, b) => {
      const gpsAngle = Math.atan2(b.dataset.latitude - a.dataset.latitude, b.dataset.longitude - a.dataset.longitude);
      const mapAngle = Math.atan2(b.dataset.y - a.dataset.y, b.dataset.x - a.dataset.x);
      gpsToMapRotation = mapAngle - gpsAngle;

      const gpsDistance = Math.sqrt(Math.pow(b.dataset.latitude - a.dataset.latitude, 2) + Math.pow(b.dataset.longitude - a.dataset.longitude, 2));
      const mapDistance = Math.sqrt(Math.pow(b.dataset.y - a.dataset.y, 2) + Math.pow(b.dataset.x - a.dataset.x, 2));
      gpsToMapScale = mapDistance / gpsDistance;

      if (!isFinite(gpsToMapScale)) {
        gpsToMapScale = 1;
      }

      gpsLatitude = a.dataset.latitude;
      gpsLongitude = a.dataset.longitude;
      mapX = a.dataset.x;
      mapY = a.dataset.y;
    };

    const plotCurrentPosition = () => {
      console.log("plotting position...");
      const locationSuccess = (position) => {
        // Create a marker element
        const marker = document.createElement("div");
        marker.className = "current-position-marker";

        const latitude = position.coords.latitude;
        const longitude = position.coords.longitude;
        console.log("position: ", latitude, longitude);
        marker.dataset.latitude = latitude;
        marker.dataset.longitude = longitude;
        document.querySelector('#current-position').innerHTML = `${latitude}, ${longitude}, ${gpsToMapRotation}, ${gpsToMapScale}`;

        // Set the marker's position based on rotation and scale
        const translateX = longitude - gpsLongitude;
        const translateY = latitude - gpsLatitude;
        const rotateX = translateX * Math.cos(gpsToMapRotation);
        const rotateY = translateY * Math.sin(gpsToMapRotation);
        const scaleX = rotateX * gpsToMapScale;
        const scaleY = rotateY * gpsToMapScale;

        const x = scaleX + mapX;
        const y = scaleY + mapY;
        marker.style.left = x + "px";
        marker.style.top = y + "px";
        marker.dataset.x = x;
        marker.dataset.y = y;

        // Append the marker to the container
        imageContainer.appendChild(marker);
      }

      const locationError = () => {
        console.log('error getting location.');
      }

      if (!navigator.geolocation) {
        console.log("Geolocation is not supported by your browser");
      } else {
        console.log("Locating…");
        navigator.geolocation.getCurrentPosition(locationSuccess, locationError);
      }
    }

    let markerId = 0;
    const markers = [];

    // Get the image element and container
    const section = document.getElementById("section");
    const image = document.getElementById("image");
    const imageContainer = document.getElementById("image-container");

    // Add a click event listener to the image
    image.addEventListener("click", function (event) {
      // Create a marker element
      const marker = document.createElement("div");
      marker.className = "marker";

      // Set the marker's position based on click coordinates
      const mouseX = event.clientX + section.scrollLeft;
      const mouseY = event.clientY + section.scrollTop;
      marker.style.left = mouseX + "px";
      marker.style.top = mouseY + "px";
      marker.dataset.x = mouseX;
      marker.dataset.y = mouseY;
      markerId++;
      marker.id = `marker_${markerId}`;

      // Append the marker to the container
      imageContainer.appendChild(marker);

      const locationSuccess = (markerId) => (position) => {
        const latitude = position.coords.latitude;
        const longitude = position.coords.longitude;
        const accuracy = position.coords.accuracy;

        console.log("position: ", latitude, longitude);
        const marker = document.getElementById(markerId);
        marker.dataset.latitude = latitude;
        marker.dataset.longitude = longitude;
        marker.dataset.accuracy = accuracy;

        if (document.querySelectorAll(".marker").length === 2) {
          const a = document.querySelectorAll('.marker')[0];
          const b = document.querySelectorAll('.marker')[1];

          document.querySelector('#ref1').innerHTML = `${a.dataset.latitude}, ${a.dataset.longitude}, ${a.dataset.accuracy}`;
          document.querySelector('#ref2').innerHTML = `${b.dataset.latitude}, ${b.dataset.longitude}, ${b.dataset.accuracy}`;

          saveTransformations(a, b);
          setInterval(plotCurrentPosition, 5 * 1000);
        }
      }
      const locationError = () => {
        console.log('error getting location.');
      }

      if (!navigator.geolocation) {
        console.log("Geolocation is not supported by your browser");
      } else {
        console.log("Locating…");
        navigator.geolocation.getCurrentPosition(locationSuccess(marker.id), locationError);
      }
    });
  </script>
</body>

</html>