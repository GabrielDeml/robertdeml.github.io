<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Static Map</title>
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    .section {
      width: 100%;
      height: 100vh;
      overflow: auto;
    }

    .image-container {
      max-width: 100%;
      max-height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .image-container img {
      max-width: 100%;
      height: auto;
    }

    .marker {
      position: absolute;
      width: 10px;
      height: 10px;
      background-color: red;
      border-radius: 50%;
      transform: translate(-50%, -50%);
    }

    .current-position-marker {
      position: absolute;
      width: 10px;
      height: 10px;
      background-color: lime;
      border-radius: 50%;
      transform: translate(-50%, -50%);
    }

    .point-data {
      position: absolute;
      bottom: 0px;
      left: 0px;
      color: black;
    }
  </style>
</head>

<body>
  <div class="section" id="section">
    <div class="image-container" id="image-container">
      <img src="your-image.JPG" alt="Your Image" id="image" />
    </div>
  </div>
  <div class="point-data">
    <div>GPS: <span id="longitude"></span> <span id="latitude"></span></div>
    <div>accuracy: <span id="accuracy"></span></div>
    <div>Pt1: <span id="markerALong"></span> <span id="markerALat"></span> <span id="markerAAcc"></span></div>
    <div>Pt2: <span id="markerBLong"></span> <span id="markerBLat"></span> <span id="markerBAcc"></span></div>
    <div>GpsDist: <span id="gpsDist"></span> MapDist: <span id="mapDist"></span></div>
  </div>

  <script>

    let gpsToMapRotation;
    let gpsToMapScale;
    let gpsLatitude;
    let gpsLongitude;
    let mapX;
    let mapY;
    let currentPositionInterval;

    function measure(lat1, lon1, lat2, lon2) {  // generally used geo measurement function
      var R = 6378.137; // Radius of earth in KM
      var dLat = lat2 * Math.PI / 180 - lat1 * Math.PI / 180;
      var dLon = lon2 * Math.PI / 180 - lon1 * Math.PI / 180;
      var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      var d = R * c;
      return d * 1000; // meters
    }

    const saveTransformations = (a, b) => {
      const gpsAngle = Math.atan2(b.dataset.latitude - a.dataset.latitude, b.dataset.longitude - a.dataset.longitude);
      const mapAngle = Math.atan2(b.dataset.y - a.dataset.y, b.dataset.x - a.dataset.x);
      gpsToMapRotation = mapAngle - gpsAngle;

      const gpsDistance = Math.sqrt(Math.pow(b.dataset.latitude - a.dataset.latitude, 2) + Math.pow(b.dataset.longitude - a.dataset.longitude, 2));
      const mapDistance = Math.sqrt(Math.pow(b.dataset.y - a.dataset.y, 2) + Math.pow(b.dataset.x - a.dataset.x, 2));
      gpsToMapScale = mapDistance / gpsDistance;

      const gpsDistanceMeters = measure(b.dataset.latitude, b.dataset.longitude, a.dataset.latitude, a.dataset.longitude);

      if (!isFinite(gpsToMapScale)) {
        gpsToMapScale = 1;
      }

      gpsLatitude = a.dataset.latitude;
      gpsLongitude = a.dataset.longitude;
      mapX = a.dataset.x;
      mapY = a.dataset.y;

      document.getElementById('gpsDist').innerHTML = gpsDistanceMeters;
      document.getElementById('mapDist').innerHTML = mapDistance;
    };

    const plotCurrentPosition = (position) => {
      // Create a marker element
      let marker = document.querySelector(".current-position-marker");
      const markerCreated = !marker;
      if (!marker) {
        marker = document.createElement("div");
      }
      marker.className = "current-position-marker";

      const latitude = position.coords.latitude;
      const longitude = position.coords.longitude;

      document.getElementById("longitude").innerHTML = longitude;
      document.getElementById("latitude").innerHTML = latitude;
      document.getElementById("accuracy").innerHTML = position.coords.accuracy;

      marker.dataset.latitude = latitude;
      marker.dataset.longitude = longitude;

      // Set the marker's position based on rotation and scale
      const translateX = longitude - gpsLongitude;
      const translateY = latitude - gpsLatitude;
      const rotateX = translateX * Math.cos(gpsToMapRotation);
      const rotateY = translateY * Math.sin(gpsToMapRotation);
      const scaleX = rotateX * gpsToMapScale;
      const scaleY = rotateY * gpsToMapScale;

      const x = scaleX + mapX;
      const y = scaleY + mapY;
      marker.style.left = x + "px";
      marker.style.top = y + "px";
      marker.dataset.x = x;
      marker.dataset.y = y;

      // Append the marker to the container
      if (markerCreated) {
        imageContainer.appendChild(marker);
      }
    }

    let markerId = 0;

    // Get the image element and container
    const section = document.getElementById("section");
    const image = document.getElementById("image");
    const imageContainer = document.getElementById("image-container");

    const appendNewPoint = (event) => {
      // Create a marker element
      const marker = document.createElement("div");
      marker.className = "marker";

      // Set the marker's position based on click coordinates
      const mouseX = event.clientX + section.scrollLeft;
      const mouseY = event.clientY + section.scrollTop;
      marker.style.left = mouseX + "px";
      marker.style.top = mouseY + "px";
      marker.dataset.x = mouseX;
      marker.dataset.y = mouseY;
      markerId++;
      marker.id = `marker_${markerId}`;

      // Append the marker to the container
      imageContainer.appendChild(marker);
      return marker.id;
    };

    // Add a click event listener to the image
    image.addEventListener("click", function (event) {
      const markerId = appendNewPoint(event);

      const locationSuccess = (position) => {
        const latitude = position.coords.latitude;
        const longitude = position.coords.longitude;
        const accuracy = position.coords.accuracy;

        const [markerA, markerB, markerC] = document.querySelectorAll('.marker');
        if (markerA && !markerB && !markerC) {
          // first marker
          markerA.dataset.latitude = latitude;
          markerA.dataset.longitude = longitude;
          markerA.dataset.accuracy = accuracy;

          document.getElementById('markerALong').innerHTML = longitude;
          document.getElementById('markerALat').innerHTML = latitude;
          document.getElementById('markerAAcc').innerHTML = accuracy;
        }
        else if (markerA && markerB && !markerC) {
          if (measure(latitude, longitude, +markerA.dataset.latitude, +markerA.dataset.longitude) < 0) { // accuracy + +markerA.dataset.accuracy) {
            markerB.remove();
            return;
          }

          // second marker
          markerB.dataset.latitude = latitude;
          markerB.dataset.longitude = longitude;
          markerB.dataset.accuracy = accuracy;

          document.getElementById('markerBLong').innerHTML = longitude;
          document.getElementById('markerBLat').innerHTML = latitude;
          document.getElementById('markerBAcc').innerHTML = accuracy;

          saveTransformations(markerA, markerB);

        }
        else {
          if (measure(latitude, longitude, +markerB.dataset.latitude, +markerB.dataset.longitude) < 0) { // accuracy + +markerB.dataset.accuracy) {
            markerC.remove();
            return;
          }

          // replace first marker
          markerA.remove();

          markerC.dataset.latitude = latitude;
          markerC.dataset.longitude = longitude;
          markerC.dataset.accuracy = accuracy;

          document.getElementById('markerALong').innerHTML = markerB.dataset.longitude;
          document.getElementById('markerALat').innerHTML = markerB.dataset.latitude;
          document.getElementById('markerAAcc').innerHTML = markerB.dataset.accuracy;

          document.getElementById('markerBLong').innerHTML = markerC.dataset.longitude;
          document.getElementById('markerBLat').innerHTML = markerC.dataset.latitude;
          document.getElementById('markerBAcc').innerHTML = markerC.dataset.accuracy;

          saveTransformations(markerB, markerC);
        }
      }
      const locationError = () => {
        console.log('error getting location.');
      }

      if (!navigator.geolocation) {
        console.log("Geolocation is not supported by your browser");
      } else {
        navigator.geolocation.getCurrentPosition(locationSuccess, locationError);
      }
    });

    if (!navigator.geolocation) {
      console.log("Geolocation is not supported by your browser");
    } else {
      navigator.geolocation.watchPosition(plotCurrentPosition);
    }
  </script>
</body>

</html>